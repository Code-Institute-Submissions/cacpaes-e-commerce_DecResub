## Validation

Here is a report of the validations made on the code and their results

- __HTML__

List of pages validated by the tool [W3C Markup Validator](https://validator.w3.org/)

| Page    |   URL  |  Result |  Link |
|    ---    |   ---  |   ---   |  ---  |
| Home    | `https://secondhandbookk.herokuapp.com/` |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2F)  |
| Book. Detail |   `https://secondhandbookk.herokuapp.com/11/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2F11%2F)  |
| Book. Rate  |   `https://secondhandbookk.herokuapp.com/3/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?useragent=Validator.nu%2FLV+http%3A%2F%2Fvalidator.w3.org%2Fservices&acceptlanguage=&doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2F3%2F)  |
| Login    |   `https://secondhandbookk.herokuapp.com/accounts/login/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Faccounts%2Flogin%2F)  | 
| Signup    |   `https://secondhandbookk.herokuapp.com/accounts/signup/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Faccounts%2Fsignup%2F)  |
| Logout    |   `https://secondhandbookk.herokuapp.com/accounts/logout/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Faccounts%2Flogout%2F)  |
| Profile    |   `https://secondhandbookk.herokuapp.com/profile/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fprofile%2F)  |
| Order Detail |   `https://secondhandbookk.herokuapp.com/profile/order_history/A494B465D42E46019AEAB3FC4CB70933`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fprofile%2Forder_history%2FA494B465D42E46019AEAB3FC4CB70933)  |
| Shopbag    |   `https://secondhandbookk.herokuapp.com/bag/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fbag%2F)  |
| Checkout    |   `https://secondhandbookk.herokuapp.com/checkout/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fcheckout%2F)  |
| Checkout Success    |   `https://secondhandbookk.herokuapp.com/checkout/checkout_success/43D1B5F723E242DBA1D859CDD2FA6CA2`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fcheckout%2Fcheckout_success%2F43D1B5F723E242DBA1D859CDD2FA6CA2)  |
| Manag. Add book   |   `https://secondhandbookk.herokuapp.com/add/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fadd%2F)  |
 Manag. Edit book    |   `https://secondhandbookk.herokuapp.com/edit/11`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fedit%2F11%2F)  |
|    Manag. Delete book    |   `https://secondhandbookk.herokuapp.com/`  |   No errors   |  [Validated](https://validator.w3.org/nu/?doc=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2F)  |

- __CSS__

List of pages validated an Unique CSS file validated by the tool [W3C Jigsaw Validator](https://jigsaw.w3.org/css-validator/)

|   Page    |   URL  |  Result |  Link |
|    ---    |   ---  |   ---   |  ---  |
| Home    | `https://secondhandbookk.herokuapp.com/` |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Book. Detail |   `https://secondhandbookk.herokuapp.com/11/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2F11%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Book. Rate  |   `https://secondhandbookk.herokuapp.com/3/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2F3%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Login    |   `https://secondhandbookk.herokuapp.com/accounts/login/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Faccounts%2Flogin%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  | 
| Signup    |   `https://secondhandbookk.herokuapp.com/accounts/signup/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Faccounts%2Fsignup%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Logout    |   `https://secondhandbookk.herokuapp.com/accounts/logout/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Faccounts%2Flogout%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Profile    |   `https://secondhandbookk.herokuapp.com/profile/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fprofile%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Order Detail |   `https://secondhandbookk.herokuapp.com/profile/order_history/A494B465D42E46019AEAB3FC4CB70933`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fprofile%2Forder_history%2FA494B465D42E46019AEAB3FC4CB70933&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Shopbag    |   `https://secondhandbookk.herokuapp.com/bag/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fbag%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Checkout    |   `https://secondhandbookk.herokuapp.com/checkout/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fcheckout%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Checkout Success    |   `https://secondhandbookk.herokuapp.com/checkout/checkout_success/43D1B5F723E242DBA1D859CDD2FA6CA2`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fcheckout%2Fcheckout_success%2F43D1B5F723E242DBA1D859CDD2FA6CA2&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
| Manag. Add book   |   `https://secondhandbookk.herokuapp.com/add/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fadd%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
 Manag. Edit book    |   `https://secondhandbookk.herokuapp.com/edit/11`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2Fedit%2F11&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |
|    Manag. Delete book    |   `https://secondhandbookk.herokuapp.com/`  |   No errors   |  [Validated](https://jigsaw.w3.org/css-validator/validator?uri=https%3A%2F%2Fsecondhandbookk.herokuapp.com%2F&profile=css3svg&usermedium=all&warning=1&vextwarning=&lang=en)  |

- __Java Script__

List of files validated by the tool [JS Hint](https://jshint.com/)

- Script 01

```
var stripePublicKey = $('#id_stripe_public_key').text().slice(1, -1);
var clientSecret = $('#id_client_secret').text().slice(1, -1);
var stripe = Stripe(stripePublicKey);
var elements = stripe.elements();
var style = {
    base: {
        color: '#000',
        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: 'antialiased',
        fontSize: '16px',
        '::placeholder': {
            color: '#aab7c4'
        }
    },
    invalid: {
        color: '#dc3545',
        iconColor: '#dc3545'
    }
};
var card = elements.create('card', {style: style});
card.mount('#card-element');

// Handle realtime validation errors on the card element
card.addEventListener('change', function (event) {
    var errorDiv = document.getElementById('card-errors');
    if (event.error) {
        var html = `
            <span class="icon" role="alert">
                <i class="fas fa-times"></i>
            </span>
            <span>${event.error.message}</span>
        `;
        $(errorDiv).html(html);
    } else {
        errorDiv.textContent = '';
    }
});

// Handle form submit
var form = document.getElementById('payment-form');

form.addEventListener('submit', function(ev) {
    ev.preventDefault();
    card.update({ 'disabled': true});
    $('#submit-button').attr('disabled', true);
    $('#payment-form').fadeToggle(100);
    $('#loading-overlay').fadeToggle(100);

    var saveInfo = Boolean($('#id-save-info').attr('checked'));
    // From using {% csrf_token %} in the form
    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
    var postData = {
        'csrfmiddlewaretoken': csrfToken,
        'client_secret': clientSecret,
        'save_info': saveInfo,
    };
    var url = '/checkout/cache_checkout_data/';

    $.post(url, postData).done(function () {
        stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: card,
                billing_details: {
                    name: $.trim(form.full_name.value),
                    phone: $.trim(form.phone_number.value),
                    email: $.trim(form.email.value),
                    address:{
                        line1: $.trim(form.street_address1.value),
                        line2: $.trim(form.street_address2.value),
                        city: $.trim(form.town_or_city.value),
                        country: $.trim(form.country.value),
                        state: $.trim(form.county.value),
                    }
                }
            },
            shipping: {
                name: $.trim(form.full_name.value),
                phone: $.trim(form.phone_number.value),
                address: {
                    line1: $.trim(form.street_address1.value),
                    line2: $.trim(form.street_address2.value),
                    city: $.trim(form.town_or_city.value),
                    country: $.trim(form.country.value),
                    postal_code: $.trim(form.postcode.value),
                    state: $.trim(form.county.value),
                }
            },
        }).then(function(result) {
            if (result.error) {
                var errorDiv = document.getElementById('card-errors');
                var html = `
                    <span class="icon" role="alert">
                    <i class="fas fa-times"></i>
                    </span>
                    <span>${result.error.message}</span>`;
                $(errorDiv).html(html);
                $('#payment-form').fadeToggle(100);
                $('#loading-overlay').fadeToggle(100);
                card.update({ 'disabled': false});
                $('#submit-button').attr('disabled', false);
            } else {
                if (result.paymentIntent.status === 'succeeded') {
                    form.submit();
                }
            }
        });
    }).fail(function () {
        // just reload the page, the error will be in django messages
        location.reload();
    });
});
```

No errors identified for this script.

<details>
    <summary>Script present in following files</summary>

| File |   file path  |
| --- |   ---  |
| 01 |  `static/js/stripe_elements.js `  |
    
</details>

- Script 02

```
function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-V4YSE287VJ');
```

No errors identified for this script.

- Script 03

```
function openSearch(){
        console.log("clique")
        $("#topnav").attr( "style", "display: none !important;" )
        $("#formSearch").css("display","flex")

    }
    const validateEmail = function (email) {
        var formData = new FormData();
        formData.append('email', email)
        $.ajaxSetup({
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            }

        });
        $.ajax({
            url: '/newsletter/validate',
            type: 'POST',
            dataType: 'json',
            cache: false,
            processData: false,
            contentType: false,
            data: formData,
            error: function (xhr) {
                console.error(xhr.statusText);
            },
            success: function (res) {
                $('.error').text(res.msg);
            }
        });
    };

    const subscribeUser = function (email, name) {
        var formData = new FormData();
        formData.append('email', email);
        formData.append('name', name);
        $.ajaxSetup({
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        $.ajax({
            url: '/newsletter/',
            type: 'POST',
            dataType: 'json',
            cache: false,
            processData: false,
            contentType: false,
            data: formData,
            error: function (xhr) {
                console.error(xhr.statusText);
            },
            success: function (res) {
                $('.success').text(res.msg);
                $('#userEmail').val(' ');
                $('#userName').val(' ');
            }
        });
    };

    (function teste($) {
        $('#submit').on('click', () => {

            event.preventDefault();
            $("#topnav").attr( "style", "display: flex !important;" )
            $("#formSearch").css("display","none")
            const userEmail = $('#userEmail').val();
            const userName = $('#userName').val();
            if (userEmail && userName) {
                subscribeUser(userEmail, userName);
            }
        });

        $('#userEmail').on('change', (event) => {
            event.preventDefault();
            const email = event.target.value;
            validateEmail(email);
        });
    })(jQuery);

```
No errors identified for this script.

<details>
    <summary>Script present in following files</summary>

| File |   file path  |
| --- |   ---  |
| 01 |  `templates/base.html `  |
    
</details>

- Script 4

```
$('.update-link').click(function(e) {
        var form = $(this).prev('.update-form');
        form.submit();
    })

    // Remove item and reload on click
    $('.remove-item').click(function(e) {
        var csrfToken = "{{ csrf_token }}";
        var itemId = $(this).attr('id').split('remove_')[1];
        var url = `/bag/remove/${itemId}/`;
        var data = {'csrfmiddlewaretoken': csrfToken};

        $.post(url, data)
         .done(function() {
             location.reload();
         });
    })
```

No errors identified for this script.

<details>
    <summary>Script present in following files</summary>

| File |   file path  |
| --- |   ---  |
| 01 |  `books/includes/quantity_input_script.html `  |
    
</details>


- __Python__

List of pages validated by the tool [PEP8CI - By Code Institute](https://pep8ci.herokuapp.com/)

- bag

No errors identified

| File |   file path  |
| --- |   ---  |
| 01 |  `bag/templatetags/bag_tools.py `  |

```
from django import template


register = template.Library()


@register.filter(name='calc_subtotal')
def calc_subtotal(price, quantity):
    return price * quantity
```

| File |   file path  |
| --- |   ---  |
| 01 |  `bag/tests/tests_views.py `  |

No errors identified

```
from books.models import Book, Category, Author
from django.contrib.auth.models import User
from django.test import TestCase
from django.urls import reverse


class BagViewsTestCase(TestCase):

    """
    Class test to bag views
    """

    def setUp(self):
        self.user = User.objects.create(username='test', password='test')
        self.user.save()

        self.category = Category.objects.create(
            name="Children's Books",
            friendly_name="Children's Books"
        )
        self.category.save()

        self.author = Author.objects.create(
            name="JK",
            details="Children's Books"
        )
        self.author.save()

        self.book = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73.54,
            category=self.category,
            author=self.author
        )
        self.book.save()

        self.book2 = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54
        )

        self.book2.save()

    def test_view_bag_sucess(self):
        """
        Test return bag user
        """
        response = self.client.get(reverse('view_bag'))
        self.assertEqual(response.status_code, 200, response)
        self.assertTemplateUsed(response, 'bag/bag.html')

    def test_view_add_bag_error_book_not_exist(self):
        """
        Test return add bag user book not exist
        """

        response = self.client.get(
            reverse('add_to_bag', kwargs={'item_id': '999999999'}))
        self.assertEqual(response.status_code, 404, response)

    def test_view_add_bag_sucess(self):
        """
        Test return add bag user
        """
        response = self.client.post(reverse('add_to_bag', kwargs={'item_id': self.book.id}), data={
                                    'quantity': 43, 'redirect_url': 'request.path'})
        self.assertEqual(response.status_code, 302, response)

    def test_view_adjust_bag_error_book_not_exist(self):
        """
        Test return adjust bag user book not exist
        """
        response = self.client.get(
            reverse('adjust_bag', kwargs={'item_id': '999999999'}))
        self.assertEqual(response.status_code, 404, response)

    def test_view_adjust_bag_sucess(self):
        """
        Test return adjust bag user
        """
        response = self.client.post(reverse('adjust_bag', kwargs={'item_id': self.book.id}), data={
                                    'quantity': 43, 'redirect_url': 'request.path'})
        self.assertEqual(response.status_code, 302, response)

    def test_view_remove_bag_error_book_not_exist(self):
        """
        Test return remove bag user book not exist
        """
        response = self.client.get(
            reverse('remove_from_bag', kwargs={'item_id': '999999999'}))
        self.assertEqual(response.status_code, 404, response)

    def test_view_adjust_remove_sucess(self):
        """
        Test return remove bag user
        """
        response = self.client.post(
            reverse('remove_from_bag', kwargs={'item_id': self.book.id}),)
        self.assertEqual(response.status_code, 500, response)

```

| File |   file path |
| --- |   ---  |
| 01 |  `bag/apps.py `  |

No errors identified

```
from django.apps import AppConfig


class BagConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'bag'

```

| File |   file path  |
| --- |   ---  |
| 01 |  `bag/contexts.py `  |

No errors identified

```
from decimal import Decimal
from django.conf import settings
from django.shortcuts import get_object_or_404
from books.models import Book


def bag_contents(request):

    bag_items = []
    total = 0
    book_count = 0
    bag = request.session.get('bag', {})

    for item_id, item_data in bag.items():
        if isinstance(item_data, int):
            book = get_object_or_404(Book, pk=item_id)
            total += item_data * book.price
            book_count += item_data
            bag_items.append({
                'item_id': item_id,
                'quantity': item_data,
                'book': book,
            })
        else:
            book = get_object_or_404(Book, pk=item_id)
            for size, quantity in item_data['items_by_size'].items():
                total += quantity * book.price
                book_count += quantity
                bag_items.append({
                    'item_id': item_id,
                    'quantity': quantity,
                    'book': book,
                    'size': size,
                })

    delivery = total * Decimal(settings.STANDARD_DELIVERY_PERCENTAGE / 100)

    grand_total = delivery + total

    context = {
        'bag_items': bag_items,
        'total': total,
        'book_count': book_count,
        'delivery': delivery,
        'grand_total': grand_total,
    }

    return context

```

| File |   file path  |
| --- |   ---  |
| 01 |  `bag/urls.py `  |

No errors identified

```
from django.urls import path
from . import views

urlpatterns = [
    path('', views.view_bag, name='view_bag'),
    path('add/<item_id>/', views.add_to_bag, name='add_to_bag'),
    path('adjust/<item_id>/', views.adjust_bag, name='adjust_bag'),
    path('remove/<item_id>/', views.remove_from_bag, name='remove_from_bag'),
]

```


| File |   file path  |
| --- |   ---  |
| 01 |  `bag/views.py `  |

No errors identified

```
from django.shortcuts import (
    render, redirect, reverse, HttpResponse, get_object_or_404, Http404
)
from django.contrib import messages

from books.models import Book


def view_bag(request):
    """ A view that renders the bag contents page """

    return render(request, 'bag/bag.html')


def add_to_bag(request, item_id):
    """ Add a quantity of the specified book to the shopping bag """

    book = get_object_or_404(Book, pk=item_id)
    quantity = int(request.POST.get('quantity'))
    redirect_url = request.POST.get('redirect_url')
    size = None
    if 'book_size' in request.POST:
        size = request.POST['book_size']
    bag = request.session.get('bag', {})

    if size:
        if item_id in list(bag.keys()):
            if size in bag[item_id]['items_by_size'].keys():
                bag[item_id]['items_by_size'][size] += quantity
                messages.success(request,
                                 (f'Updated size {size.upper()} '
                                  f'{book.name} quantity to '
                                  f'{bag[item_id]["items_by_size"][size]}'))
            else:
                bag[item_id]['items_by_size'][size] = quantity
                messages.success(request,
                                 (f'Added size {size.upper()} '
                                  f'{book.name} to your bag'))
        else:
            bag[item_id] = {'items_by_size': {size: quantity}}
            messages.success(request,
                             (f'Added size {size.upper()} '
                              f'{book.name} to your bag'))
    else:
        if item_id in list(bag.keys()):
            bag[item_id] += quantity
            messages.success(request,
                             (f'Updated {book.name} '
                              f'quantity to {bag[item_id]}'))
        else:
            bag[item_id] = quantity
            messages.success(request, f'Added {book.name} to your bag')

    request.session['bag'] = bag
    return redirect(redirect_url)


def adjust_bag(request, item_id):
    """Adjust the quantity of the specified book to the specified amount"""

    book = get_object_or_404(Book, pk=item_id)
    quantity = int(request.POST.get('quantity'))
    size = None
    if 'book_size' in request.POST:
        size = request.POST['book_size']
    bag = request.session.get('bag', {})

    if size:
        if quantity > 0:
            bag[item_id]['items_by_size'][size] = quantity
            messages.success(request,
                             (f'Updated size {size.upper()} '
                              f'{book.name} quantity to '
                              f'{bag[item_id]["items_by_size"][size]}'))
        else:
            del bag[item_id]['items_by_size'][size]
            if not bag[item_id]['items_by_size']:
                bag.pop(item_id)
            messages.success(request,
                             (f'Removed size {size.upper()} '
                              f'{book.name} from your bag'))
    else:
        if quantity > 0:
            bag[item_id] = quantity
            messages.success(request,
                             (f'Updated {book.name} '
                              f'quantity to {bag[item_id]}'))
        else:
            bag.pop(item_id)
            messages.success(request,
                             (f'Removed {book.name} '
                              f'from your bag'))

    request.session['bag'] = bag
    return redirect(reverse('view_bag'))


def remove_from_bag(request, item_id):
    """Remove the item from the shopping bag"""

    try:
        book = get_object_or_404(Book, pk=item_id)

        bag = request.session.get('bag', {})
        bag.pop(item_id)
        messages.success(request, f'Removed {book.name} from your bag')

        request.session['bag'] = bag
        return HttpResponse(status=200)

    except Http404 as e:
        messages.error(request, f'Error removing item: {e}')
        return HttpResponse(status=404)
    except Exception as e:
        messages.error(request, f'Error removing item: {e}')
        return HttpResponse(status=500)

```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/tests/tests_forms.py `  |

No errors identified

```
from django.test import TestCase
from books.forms import ReviewForm, BookForm
from books.models import Category

"""
class to test form ReviewForm
"""


class ReviewFormTestCase(TestCase):

    def test_review_form_valid(self):
        """
        Check if the form is valid
        """
        form = ReviewForm(data={
            'review': 1,
        })
        self.assertTrue(form.is_valid())

    def test_review_form_invalid_skip_value_review(self):
        """
        Check if the form is invalid, parameter name not review
        """
        form = ReviewForm(data={
            'review': None,
        })
        self.assertFalse(form.is_valid(), form.errors)

    def test_review_form_invalid_review_negative(self):
        """
        Check if the form is invalid, parameter review value negative
        """
        form = ReviewForm(data={
            'review': -5,
        })
        self.assertFalse(form.is_valid(), form.errors)

    def test_review_form_invalid_review_value_greather_than_five(self):
        """
        Check if the form is invalid, parameter review value greather than 5 
        """
        form = ReviewForm(data={
            'review': 10,
        })
        self.assertFalse(form.is_valid(), form.errors)


"""
class to test form BookForm
"""


class BookFormTestCase(TestCase):

    def setUp(self):
        """
        Create setup book form
        """
        self.category = Category.objects.create(
            name="Children's Books",
            friendly_name="Children's Books"
        )

        self.category.save()

    def test_book_form_valid(self):
        """
        Check if the form is valid
        """
        form = BookForm(data={
            'name': 'Harry Potter',
            'description': 'The best book',
            'price': 70
        })
        self.assertTrue(form.is_valid())

    def test_book_form_invalid_skip_value_name(self):
        """
        Check if the form is invalid, parameter name blank
        """
        form = BookForm(data={
            'description': 'The best book',
            'price': 70
        })
        self.assertFalse(form.is_valid(), form.errors)

    def test_book_form_invalid_description(self):
        """
        Check if the form is invalid, parameter description none
        """
        form = BookForm(data={
            'name': 'Harry Potter',
            'price': 70
        })
        self.assertFalse(form.is_valid(), form.errors)

    def test_book_form_invalid_price_none(self):
        """
        Check if the form is invalid, parameter price none
        """
        form = BookForm(data={
            'name': 'Harry Potter',
            'description': 'The best book',
        })
        self.assertFalse(form.is_valid(), form.errors)


```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/tests/tests_models.py `  |

No errors identified

```
from django.contrib.auth.models import User
from django.test import TestCase
from books.models import Review, Book, Category, Author
from decimal import *

"""
class to test model Review
"""


class ReviewTestCase(TestCase):

    def setUp(self):
        """
        Defined function before condition for test
        """

        self.user = User.objects.create(username='test', password='test')
        self.user.save()
        user2 = User.objects.create(username='test2', password='test2')

        book = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73.54
        )

        book2 = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54
        )

        Review.objects.create(
            user=self.user,
            book=book,
            review=4
        )

        Review.objects.create(
            user=user2,
            book=book,
            review=5,
        )

    def test_review_return_str(self):
        """
        Test string for review
        """
        review = Review.objects.get(user=self.user)
        self.assertEquals(review.__str__(), "Harry Potter")

    def test_confirm_data(self):
        """
        Test confirm objects atributes
        """
        review = Review.objects.get(user=self.user)
        self.assertEquals(review.review, 4)
        self.assertEquals(review.reviewed, True)

    def test_review_orderind(self):
        """
        Test ordering review
        """
        reviews = Review.objects.all()
        self.assertEquals(reviews[0].review, 4)
        self.assertEquals(reviews[1].review, 5)
        self.assertGreater(reviews[1].created_on, reviews[0].created_on)


"""
class to test model Category
"""


class CategoryTestCase(TestCase):

    def setUp(self):
        """
        Defined function before condition for test
        """

        user = User.objects.create(username='test', password='test')

        category_children = Category.objects.create(
            name="Children's Books",
            friendly_name="Children's Books"
        )

        category_health = Category.objects.create(
            name="Health",
            friendly_name="Health"
        )

        category_food = Category.objects.create(
            name="Food&Drink",
            friendly_name="Food&Drink"
        )

        category_crime = Category.objects.create(
            name="Crime, Thrillers&Mystery",
            friendly_name="Crime, Thrillers&Mystery"
        )

        book_children = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73.54,
            category=category_children
        )

        book_health = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54,
            category=category_health
        )

        book_food = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54,
            category=category_food
        )

        book_crime = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54,
            category=category_crime
        )

    def test_cetegory_return_str(self):
        """
        Test string for cetegory
        """
        category = Category.objects.get(name="Children's Books")
        self.assertEquals(category.__str__(), "Children's Books")

    def test_confirm_data(self):
        """
        Test confirm objects atributes
        """
        category = Category.objects.get(name="Health")
        self.assertEquals(category.name, "Health")
        self.assertEquals(category.friendly_name, "Health")


"""
class to test model Author
"""


class AuthorTestCase(TestCase):

    def setUp(self):
        """
        Defined function before condition for test
        """

        self.user = User.objects.create(username='test', password='test')
        self.user.save()

        self.author = Author.objects.create(
            name="JK",
            details="Children's Books"
        )
        self.author.save()

        self.category_children = Category.objects.create(
            name="Children's Books",
            friendly_name="Children's Books"
        )
        self.category_children.save()

        book_children = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73.54,
            category=self.category_children,
            author=self.author
        )

    def test_author_return_str(self):
        """
        Test string for author
        """
        author = Author.objects.get(name="JK")
        self.assertIsNotNone(author)
        self.assertEquals(author.__str__(), "JK")

    def test_confirm_data(self):
        """
        Test confirm objects atributes
        """
        author = Author.objects.get(name="JK")
        self.assertEquals(author.name, "JK")
        self.assertEquals(author.details, "Children's Books")


"""
class to test model Books
"""


class BookTestCase(TestCase):

    def setUp(self):
        """
        Defined function before condition for test
        """

        book = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73
        )

        book2 = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54
        )

    def test_book_return_str(self):
        """
        Test string for book
        """
        book = Book.objects.get(name="Harry Potter")
        self.assertEquals(book.__str__(), "Harry Potter")

    def test_confirm_data(self):
        """
        Test confirm objects atributes
        """
        book = Book.objects.get(name="Harry Potter")
        self.assertIsNotNone(book)
        self.assertEquals(book.name, "Harry Potter")
        self.assertEquals(book.description, "is very good book")
        self.assertEquals(book.price, Decimal(73))

```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/tests/tests_views.py `  |

No errors identified

```
from books.models import Book, Category, Author
from django.contrib.auth.models import User
from django.test import TestCase
from django.urls import reverse


class BookingViewsTestCase(TestCase):

    def setUp(self):
        self.user = User.objects.create(username='test', password='test')
        self.user.save()

        self.category = Category.objects.create(
            name="Children's Books",
            friendly_name="Children's Books"
        )
        self.category.save()

        self.author = Author.objects.create(
            name="JK",
            details="Children's Books"
        )
        self.author.save()

        self.book = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73.54,
            category=self.category,
            author=self.author
        )
        self.book.save()

        self.book2 = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54
        )

        self.book2.save()

        self.my_admin = User.objects.create_superuser(username='myemail@test.com', password='mypassword')
        self.my_admin.save()

    def test_all_books_sucess_200(self):
        """
        View return all books, not parametes
        """
        response = self.client.get(reverse('books'))
        self.assertEqual(response.status_code, 200, response)
        self.assertTemplateUsed(response, 'books/books.html')

    def test_detail_book_sucess_200(self):
        """
        View return details book
        """
        response = self.client.get(reverse('book_detail', kwargs={'book_id': self.book.id}))
        self.assertEqual(response.status_code, 200, response)
        self.assertTemplateUsed(response, 'books/book_detail.html')

    def test_detail_book_error_404(self):
        """
        View return error book 404
        """
        response = self.client.get(reverse('book_detail', kwargs={'book_id': '999999999'}))
        self.assertEqual(response.status_code, 404, response)

    def test_add_book_not_permission(self):
        """
        View return error add book user not permission 403, reponse redirect
        """
        response = self.client.get(reverse('add_book'))
        self.assertEqual(response.status_code, 302, response)

    def test_edit_book_not_permission(self):
        """
        View return error edit book user not permission 403, reponse redirect
        """
        response = self.client.get(reverse('edit_book', kwargs={'book_id': '999999999'}))
        self.assertEqual(response.status_code, 302, response)

    def test_delete_book_not_permission(self):
        """
        View return error delete book user not permission 403, reponse redirect
        """
        response = self.client.get(reverse('delete_book', kwargs={'book_id': '999999999'}))
        self.assertEqual(response.status_code, 302, response)

    def test_delete_book_sucess(self):
        """
        View return delete book
        """
        self.client.login(username='myemail@test.com', password='mypassword')
        book = Book.objects.get(id=self.book.id)
        self.assertIsNotNone(book)
        response = self.client.get(reverse('delete_book', kwargs={'book_id': self.book.id}))
        self.assertEqual(response.status_code, 302, response)
        book = Book.objects.filter(id=self.book.id).first()
        self.assertIsNone(book)

```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/admin.py `  |

No errors identified
```
from django.contrib import admin

from .models import Book, Category, Author, Review

# Register your models here.


class BookAdmin(admin.ModelAdmin):
    list_display = (
        'sku',
        'name',
        'category',
        'price',
        'rating',
        'image',
        'author',
    )

    ordering = ('sku',)


class ReviewAdmin(admin.ModelAdmin):
    list_display = (
        'book',
        'user',
        'created_on',
        'review'
    )    
    ordering = ('book',)


class CategoryAdmin(admin.ModelAdmin):

    list_display = (
        'friendly_name',
        'name',
    )


class AuthorAdmin(admin.ModelAdmin):
    list_display = (
        'name',
        'image',
        'details',
        'site_url'
    )    


admin.site.register(Book, BookAdmin)
admin.site.register(Author, AuthorAdmin)
admin.site.register(Category, CategoryAdmin)
admin.site.register(Review, ReviewAdmin)

```
| File |   file path  |
| --- |   ---  |
| 01 |  `books/apps.py `  |

No errors identified
```

from django.apps import AppConfig


class BooksConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'books'
   
```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/forms.py `  |

No errors identified
```
class BookForm(forms.ModelForm):
    """
    Class user validated book and created new 
    """

    class Meta:
        model = Book
        fields = '__all__'

    image = forms.ImageField(label='Image',
                             required=False,
                             widget=CustomClearableFileInput)

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        categories = Category.objects.all()
        friendly_names = [(c.id, c.get_friendly_name()) for c in categories]

        self.fields['category'].choices = friendly_names
        for field_name, field in self.fields.items():
            field.widget.attrs['class'] = 'border-black rounded-0'


class ReviewForm(forms.ModelForm):
    """
    Class user validated review in the book and created new  
    """
    CHOICES = (('1', '1'), ('2', '2'), ('3', '3'), ('4', '4'), ('5', '5'))
    review = forms.ChoiceField(choices=CHOICES, label="Rate", widget=forms.Select)

    class Meta:
        model = Review
        fields = ('review', )

   
```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/urls.py `  |

No errors identified
```
from django.urls import path

from . import views

urlpatterns = [
    path('', views.all_books, name='books'),
    path('<int:book_id>/', views.book_detail, name='book_detail'),
    path('add/', views.add_book, name='add_book'),
    path('edit/<int:book_id>/', views.edit_book, name='edit_book'),
    path('delete/<int:book_id>/',
         views.delete_book,
         name='delete_book'),
    path('reviews/<int:book_id>/', views.add_review, name='reviews_book')
]

```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/views.py `  |

No errors identified
```
from django.shortcuts import render, redirect, reverse, get_object_or_404
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.db.models import Q, Avg
from django.db.models.functions import Lower
from comment.forms import CommentForm
from .models import Book, Category, Review
from .forms import BookForm, ReviewForm

# Create your views here.


def all_books(request):
    """ A view to show all books, including sorting and search queries """

    books = Book.objects.all()
    query = None
    categories = None
    sort = None
    direction = None
    style = "display: block;"

    if request.GET:
        style = "display: none;"
        if 'sort' in request.GET:
            sortkey = request.GET['sort']
            sort = sortkey
            if sortkey == 'name':
                sortkey = 'lower_name'
                books = books.annotate(lower_name=Lower('name'))
            if sortkey == 'category':
                sortkey = 'category__name'
            if 'direction' in request.GET:
                direction = request.GET['direction']
                if direction == 'desc':
                    sortkey = f'-{sortkey}'
            books = books.order_by(sortkey)

        if 'category' in request.GET:
            categories = request.GET['category'].split(',')
            books = books.filter(category__name__in=categories)
            categories = Category.objects.filter(name__in=categories)

        if 'q' in request.GET:
            query = request.GET['q']
            if not query:
                messages.error(request,
                               ("You didn't enter any search criteria!"))
                return redirect(reverse('books'))

            queries = Q(name__icontains=query) | Q(
                description__icontains=query)
            books = books.filter(queries)

    current_sorting = f'{sort}_{direction}'

    context = {
        'books': books,
        'search_term': query,
        'current_categories': categories,
        'current_sorting': current_sorting,
        'style': style
    }

    return render(request, 'books/books.html', context)


@login_required
def add_book(request):
    """ Add a book to the store """
    if not request.user.is_superuser:
        messages.error(request, 'Sorry, only store owners can do that.')
        return redirect(reverse('books'))

    if request.method == 'POST':
        form = BookForm(request.POST, request.FILES)
        if form.is_valid():
            book = form.save()
            messages.success(request, 'Successfully added book!')
            return redirect(reverse('book_detail', args=[book.id]))
        else:
            messages.error(request,
                           ('Failed to add book. '
                            'Please ensure the form is valid.'))
    else:
        form = BookForm()

    template = 'books/add_book.html'
    context = {
        'form': form,
    }

    return render(request, template, context)


@login_required
def edit_book(request, book_id):
    """ Edit a book in the store """
    if not request.user.is_superuser:
        messages.error(request, 'Sorry, only store owners can do that.')
        return redirect(reverse('books'))

    book = get_object_or_404(Book, pk=book_id)
    if request.method == 'POST':
        form = BookForm(request.POST, request.FILES, instance=book)
        if form.is_valid():
            form.save()
            messages.success(request, 'Successfully updated book!')
            return redirect(reverse('book_detail', args=[book.id]))
        else:
            messages.error(request,
                           ('Failed to update book. '
                            'Please ensure the form is valid.'))
    else:
        form = BookForm(instance=book)
        messages.info(request, f'You are editing {book.name}')

    template = 'books/edit_book.html'
    context = {
        'form': form,
        'book': book,
    }

    return render(request, template, context)


@login_required
def delete_book(request, book_id):
    """ Delete a book from the store """
    if not request.user.is_superuser:
        messages.error(request, 'Sorry, only store owners can do that.')
        return redirect(reverse('books'))

    book = get_object_or_404(Book, pk=book_id)
    book.delete()
    messages.success(request, 'Book deleted!')
    return redirect(reverse('books'))


def book_detail(request, book_id):
    """ A view to show individual book details """

    book = get_object_or_404(Book, pk=book_id)
    comments = book.comments.filter(active=True)
    new_comment = None
    reviews = book.review.filter(reviewed=True).order_by("-created_on")
    total_review = reviews.count()
    avg_review = reviews.aggregate(review=Avg('review'))['review']

    if avg_review is None:
        avg_review = 0

    if request.method == 'POST' and request.user:
        comment_form = CommentForm(data=request.POST)
        if comment_form.is_valid():
            new_comment = comment_form.save(commit=False)
            new_comment.book = book
            new_comment.save()

        review_form = ReviewForm(data=request.POST)
        if review_form.is_valid():
            review = Review.objects.filter(user=request.user, book=book)[::1]
            if len(review) > 0:
                review_edit = review[0]
                review_edit.review = review_form['review'].value()
                review_edit.save()
            else:
                new_review = review_form.save(commit=False)
                new_review.book = book
                new_review.user = request.user
                new_review.save()
            reviews = book.review.filter(reviewed=True).order_by("-created_on")
            total_review = reviews.count()
            avg_review = reviews.aggregate(review=Avg('review'))['review']
            book.rating = avg_review
            book.save()
    else:
        comment_form = CommentForm()
        review_form = ReviewForm()

    context = {
        'book': book, 'comments': comments, 'new_comment': new_comment, 'comment_form': comment_form, 'reviews': reviews,
        'total_review': total_review, 'avg_review': avg_review, 'review_form': review_form, 'iterator': range(1, 6)
    }

    return render(request, 'books/book_detail.html', context)


@login_required()
def add_review(request, book_id):
    """ View to add review in book"""
    book = get_object_or_404(Book, pk=book_id)
    reviews = book.review.filter(reviewed=True).order_by("-created_on")

    if request.method == 'POST' and request.user:
        review_form = ReviewForm(data=request.POST)
        if review_form.is_valid():
            new_review = review_form.save(commit=False)
            new_review.book = book
            new_review.user = request.user
            new_review.save()
    else:
        review_form = ReviewForm()

    context = {
        'reviews': reviews, 'book': book, 'review_form': review_form
    }

    return render(request, 'books/review_detail.html', context)

```

| File |   file path  |
| --- |   ---  |
| 01 |  `books/widgets.py `  |

No errors identified
```
from django.forms.widgets import ClearableFileInput
from django.utils.translation import gettext_lazy as _


class CustomClearableFileInput(ClearableFileInput):
    clear_checkbox_label = _('Remove')
    initial_text = _('Current Image')
    input_text = _('')
    template_name = 'books/custom_widget_templates/custom_clearable_file_input.html'

```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/tests/tests_forms.py `  |

No errors identified

```
from django.test import TestCase
from checkout.forms import OrderForm
from checkout.models import Order
from django_countries.fields import CountryField
"""
class to test form OrderFormTestCase
"""


class OrderFormTestCase(TestCase):

    def test_order_form_valid(self):
        """
        Check if the form is valid
        """

        form = OrderForm(data={
            'full_name': 'jfkhadkfhds',
            'email': 'carlos@gmail.com',
            'phone_number': '91265656532',
            'street_address1': 'grafton street',
            'street_address2': 'grafton street',
            'town_or_city': 'Dublin',
            'postcode': '65655',
            'country': 'NZ',
            'county': 'Dublin',
        })
        self.assertTrue(form.is_valid())

    def test_checkout_form_invalid_skip_value_full_name(self):
        """
        Check if the form is invalid, parameter full name
        """
        form = OrderForm(data={
            'email': 'carlos@gmail.com',
            'phone_number': '91265656532',
            'street_address1': 'grafton street',
            'town_or_city': 'Dublin',
            'postcode': '65655',
            'country': 'NZ',
        })
        self.assertFalse(form.is_valid(), form.errors)

    def test_ordem_form_invalid_email(self):
        """
        Check if the form is invalid, parameter email
        """
        form = OrderForm(data={
            'full_name': 'jfkhadkfhds',
            'phone_number': '91265656532',
            'street_address1': 'grafton street',
            'town_or_city': 'Dublin',
            'postcode': '65655',
            'country': 'NZ',
        })
        self.assertFalse(form.is_valid(), form.errors)

    def test_phone_number_form_invalid(self):
        """
        Check if the form is invalid, parameter phone number
        """
        form = OrderForm(data={
            'full_name': 'jfkhadkfhds',
            'email': 'carlos@gmail.com',
            'street_address1': 'grafton street',
            'town_or_city': 'Dublin',
            'postcode': '65655',
            'country': 'NZ',
        })
        self.assertFalse(form.is_valid(), form.errors)

    def test_country_number_form_invalid(self):
        """
        Check if the form is invalid, country phone number
        """
        form = OrderForm(data={
            'full_name': 'jfkhadkfhds',
            'phone_number': '91265656532',
            'email': 'carlos@gmail.com',
            'street_address1': 'grafton street',
            'town_or_city': 'Dublin',
            'postcode': '65655',
        })
        self.assertFalse(form.is_valid(), form.errors)

```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/tests/tests_models.py `  |

No errors identified

```
+from django.contrib.auth.models import User
from django.test import TestCase
from books.models import Book
from checkout.models import Order, OrderLineItem
import uuid

"""
class to test model Order
"""


class OrderTestCase(TestCase):

    def setUp(self):

        """
        Defined function before condition for test
        """

        self.uuid_number = uuid.uuid4()

        self.user = User.objects.create(username='test', password='test')

        self.user.save()
        user2 = User.objects.create(username='test2', password='test2')

        order = Order.objects.create(
            order_number=self.uuid_number,
            full_name="Carlos",
            email="teste@gmail.com",
            phone_number="989791428",
            country="ireland",
            town_or_city="Dublin",
            street_address1="grafton street",
            delivery_cost=20,
            order_total=45,
            grand_total=65,
            original_bag="bag",
            stripe_pid="9898"
        )

    def test_order_return_str(self):
        """
        Test string for Order
        """
        order = Order.objects.get(order_number=self.uuid_number)
        self.assertEquals(order.__str__(), str(self.uuid_number))


"""
class to test model Order Line Item
"""


class OrderLineItemTestCase(TestCase):

    def setUp(self):
        """
        Defined function before condition for test
        """

        self.uuid_number = uuid.uuid4()

        self.user = User.objects.create(username='test', password='test')

        self.user.save()

        self.book = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73.54,
        )
        self.book.save()

        self.order = Order.objects.create(
            full_name="Carlos",
            email="teste@gmail.com",
            phone_number="989791428",
            country="ireland",
            town_or_city="Dublin",
            street_address1="grafton street",
            delivery_cost=20,
            order_total=45,
            grand_total=65,
            original_bag="bag",
            stripe_pid="9898"
        )
        self.order.save()

        order_line_item = OrderLineItem.objects.create(
            book=self.book,
            order=self.order,
            lineitem_total=5,
            quantity=12
        )

    def test_order_line_item_return_str(self):
        """
        Test string for OrderLineItem
        """
        order = OrderLineItem.objects.get(book=self.book)
        self.assertEquals(order.__str__(), f'SKU {self.book.sku} on order {self.order.order_number}')

```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/tests/tests_views.py `  |

No errors identified

```
from books.models import Book, Category, Author
from django.contrib.auth.models import User
from django.test import TestCase
from django.urls import reverse
from checkout.models import Order


class BookingViewsTestCase(TestCase):

    def setUp(self):
        self.user = User.objects.create(username='test', password='test')
        self.user.save()

        self.category = Category.objects.create(
            name="Children's Books",
            friendly_name="Children's Books"
        )
        self.category.save()

        self.author = Author.objects.create(
            name="JK",
            details="Children's Books"
        )
        self.author.save()

        self.book = Book.objects.create(
            name="Harry Potter",
            description="is very good book",
            price=73.54,
            category=self.category,
            author=self.author
        )
        self.book.save()

        self.book2 = Book.objects.create(
            name="think and grow rich ",
            description="is very good book",
            price=82.54
        )

        self.book2.save()

        test_user1 = User.objects.create_user(
            username='testuser1', password='1X<ISRUkw+tuK')
        test_user2 = User.objects.create_user(
            username='testuser2', password='2HJ1vRV0Z&3iD')

        test_user1.save()
        test_user2.save()

        self.my_admin = User.objects.create_superuser(
            username='myemail@test.com', password='mypassword')
        self.my_admin.save()

    def test_cache_checkout_data_sucess_200(self):
        """
        View checkout, parametes
        """
        response = self.client.post(reverse('cache_checkout_data'), data={
                                    'client_secret': 'pi_3M5yYaAqyUAdlutt0EqCCs5Z_secret_RlAGjaO9t8n7uX44mIgp0Yp4C'})
        self.assertEqual(response.status_code, 200, response)

    def test_cache_checkout_erro_400(self):
        """
        View checkout, not parametes error
        """
        response = self.client.post(reverse('cache_checkout_data'))
        self.assertEqual(response.status_code, 400, response)

    def test_checkout_erro_302(self):
        """
        View checkout, not parametes error
        """
        response = self.client.get(reverse('checkout'))
        self.assertEqual(response.status_code, 302, response)
        self.assertEqual(response.url, '/accounts/login/', response)

    def test_checkout_form(self):
        """
        View checkout, form checkout
        """
        response = self.client.post(reverse('checkout'), data={'full_name': 'RENAN+RIBEIRO+LAGE',
                                                               'email': 'renan.lagee@gmail.com', 'phone_number': '31989791428',
                                                               'street_address1': 'Rua+francisco+ovidio+227', 'street_address2': 'ap2',
                                                               'town_or_city': 'Belo+Horizonte', 'county': 'MG', 'postcode': '30770040',
                                                               'country': 'BR', 'save-info': 'on',
                                                               'client_secret': 'pi_3M5yYaAqyUAdlutt0EqCCs5Z_secret_RlAGjaO9t8n7uX44mIgp0Yp4C'})
        self.assertEqual(response.status_code, 302, response)
        self.assertIn('/accounts/login/', response.url)

    def test_checkout_sucess_ordem_not_pass(self):
        """
        View checkout, checkout sucess order not parameter invalid
        """

        response = self.client.get(
            reverse('checkout_success', kwargs={'order_number': 9898989}))
        self.assertEqual(response.status_code, 404, response)

    def test_checkout_sucess_ordem_pass_sucess(self):
        """
        View checkout, checkout sucess order valid
        """

        order = Order.objects.create(
            full_name="Carlos",
            email="teste@gmail.com",
            phone_number="989791428",
            country="ireland",
            town_or_city="Dublin",
            street_address1="grafton street",
            delivery_cost=20,
            order_total=45,
            grand_total=65,
            original_bag="bag",
            stripe_pid="9898"
        )

        response = self.client.get(reverse('checkout_success', kwargs={
                                   'order_number': order.order_number}))
        self.assertEqual(response.status_code, 200, response)


```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/admin.py `  |

No errors identified
```
from django.contrib import admin
from .models import Order, OrderLineItem


class OrderLineItemAdminInline(admin.TabularInline):
    model = OrderLineItem
    readonly_fields = ('lineitem_total',)


class OrderAdmin(admin.ModelAdmin):
    inlines = (OrderLineItemAdminInline,)

    readonly_fields = ('order_number', 'date',
                       'delivery_cost', 'order_total',
                       'grand_total', 'original_bag',
                       'stripe_pid')

    fields = ('order_number', 'user_profile', 'date', 'full_name',
              'email', 'phone_number', 'country',
              'postcode', 'town_or_city', 'street_address1',
              'street_address2', 'county', 'delivery_cost',
              'order_total', 'grand_total', 'original_bag',
              'stripe_pid')

    list_display = ('order_number', 'date', 'full_name',
                    'order_total', 'delivery_cost',
                    'grand_total',)

    ordering = ('-date',)


admin.site.register(Order, OrderAdmin)

```
| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/apps.py `  |

No errors identified
```

from django.apps import AppConfig


class CheckoutConfig(AppConfig):
    name = 'checkout'

    def ready(self):
        import checkout.signals

   
```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/forms.py `  |

No errors identified
```
from django import forms
from .models import Order


class OrderForm(forms.ModelForm):
    class Meta:
        model = Order
        fields = ('full_name', 'email', 'phone_number',
                  'street_address1', 'street_address2',
                  'town_or_city', 'postcode', 'country',
                  'county',)

    def __init__(self, *args, **kwargs):
        """
        Add placeholders and classes, remove auto-generated
        labels and set autofocus on first field
        """
        super().__init__(*args, **kwargs)
        placeholders = {
            'full_name': 'Full Name',
            'email': 'Email Address',
            'phone_number': 'Phone Number',
            'postcode': 'Postal Code',
            'town_or_city': 'Town or City',
            'street_address1': 'Street Address 1',
            'street_address2': 'Street Address 2',
            'county': 'County, State or Locality',
        }

        self.fields['full_name'].widget.attrs['autofocus'] = True
        for field in self.fields:
            if field != 'country':
                if self.fields[field].required:
                    placeholder = f'{placeholders[field]} *'
                else:
                    placeholder = placeholders[field]
                self.fields[field].widget.attrs['placeholder'] = placeholder
            self.fields[field].widget.attrs['class'] = 'stripe-style-input'
            self.fields[field].label = False

   
```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/models.py `  |

No errors identified
```
import uuid

from django.db import models
from django.db.models import Sum
from django.conf import settings

from django_countries.fields import CountryField

from books.models import Book
from profiles.models import UserProfile


class Order(models.Model):
    order_number = models.CharField(max_length=32, null=False, editable=False)
    user_profile = models.ForeignKey(UserProfile, on_delete=models.SET_NULL,
                                     null=True, blank=True,
                                     related_name='orders')
    full_name = models.CharField(max_length=50, null=False, blank=False)
    email = models.EmailField(max_length=254, null=False, blank=False)
    phone_number = models.CharField(max_length=20, null=False, blank=False)
    country = CountryField(blank_label='Country *', null=False, blank=False)
    postcode = models.CharField(max_length=20, null=True, blank=True)
    town_or_city = models.CharField(max_length=40, null=False, blank=False)
    street_address1 = models.CharField(max_length=80, null=False, blank=False)
    street_address2 = models.CharField(max_length=80, null=True, blank=True)
    county = models.CharField(max_length=80, null=True, blank=True)
    date = models.DateTimeField(auto_now_add=True)
    delivery_cost = models.DecimalField(max_digits=6, decimal_places=2,
                                        null=False, default=0)
    order_total = models.DecimalField(max_digits=10, decimal_places=2,
                                      null=False, default=0)
    grand_total = models.DecimalField(max_digits=10, decimal_places=2,
                                      null=False, default=0)
    original_bag = models.TextField(null=False, blank=False, default='')
    stripe_pid = models.CharField(max_length=254, null=False, blank=False,
                                  default='')

    def _generate_order_number(self):
        """
        Generate a random, unique order number using UUID
        """
        return uuid.uuid4().hex.upper()

    def update_total(self):
        """
        Update grand total each time a line item is added,
        accounting for delivery costs.
        """
        self.order_total = self.lineitems.aggregate(
            Sum('lineitem_total'))['lineitem_total__sum'] or 0
        sdp = settings.STANDARD_DELIVERY_PERCENTAGE
        self.delivery_cost = self.order_total * sdp / 100

        self.grand_total = self.order_total + self.delivery_cost
        self.save()

    def save(self, *args, **kwargs):
        """
        Override the original save method to set the order number
        if it hasn't been set already.
        """
        if not self.order_number:
            self.order_number = self._generate_order_number()
        super().save(*args, **kwargs)

    def __str__(self):
        return self.order_number


class OrderLineItem(models.Model):
    order = models.ForeignKey(Order, null=False, blank=False,
                              on_delete=models.CASCADE,
                              related_name='lineitems')
    book = models.ForeignKey(Book, null=False, blank=False,
                             on_delete=models.CASCADE)
    quantity = models.IntegerField(null=False, blank=False, default=0)
    lineitem_total = models.DecimalField(max_digits=6, decimal_places=2,
                                         null=False, blank=False,
                                         editable=False)

    def save(self, *args, **kwargs):
        """
        Override the original save method to set the lineitem total
        and update the order total.
        """
        self.lineitem_total = self.book.price * self.quantity
        super().save(*args, **kwargs)

    def __str__(self):
        return f'SKU {self.book.sku} on order {self.order.order_number}'

```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/signals.py `  |

No errors identified
```
from django.db.models.signals import post_save, post_delete
from django.dispatch import receiver

from .models import OrderLineItem


@receiver(post_save, sender=OrderLineItem)
def update_on_save(sender, instance, created, **kwargs):
    """
    Update order total on lineitem update/create
    """
    instance.order.update_total()


@receiver(post_delete, sender=OrderLineItem)
def update_on_delete(sender, instance, **kwargs):
    """
    Update order total on lineitem delete
    """
    instance.order.update_total()

```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/urls.py `  |

No errors identified
```
from django.urls import path
from . import views
from .webhooks import webhook

urlpatterns = [
    path('', views.checkout, name='checkout'),
    path('checkout_success/<order_number>',
         views.checkout_success,
         name='checkout_success'),
    path('cache_checkout_data/',
         views.cache_checkout_data,
         name='cache_checkout_data'),
    path('wh/', webhook, name='webhook'),
]

```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/views.py `  |

No errors identified
```
from django.shortcuts import (
    render, redirect, reverse, get_object_or_404, HttpResponse
)
from django.views.decorators.http import require_POST
from django.contrib import messages
from django.conf import settings

from .forms import OrderForm
from .models import Order, OrderLineItem

from books.models import Book
from profiles.models import UserProfile
from profiles.forms import UserProfileForm
from bag.contexts import bag_contents

import stripe
import json


class BookUnavailableBook(Exception):
    pass


@require_POST
def cache_checkout_data(request):
    try:
        pid = request.POST.get('client_secret').split('_secret')[0]
        stripe.api_key = settings.STRIPE_SECRET_KEY
        stripe.PaymentIntent.modify(pid, metadata={
            'bag': json.dumps(request.session.get('bag', {})),
            'save_info': request.POST.get('save_info'),
            'username': request.user,
        })
        return HttpResponse(status=200)
    except Exception as e:
        messages.error(request, ('Sorry, your payment cannot be '
                                 'processed right now. Please try '
                                 'again later.'))
        return HttpResponse(content=e, status=400)


def checkout(request):
    stripe_public_key = settings.STRIPE_PUBLIC_KEY
    stripe_secret_key = settings.STRIPE_SECRET_KEY
    if request.user.is_authenticated:

        if request.method == 'POST':
            bag = request.session.get('bag', {})

            form_data = {
                'full_name': request.POST['full_name'],
                'email': request.POST['email'],
                'phone_number': request.POST['phone_number'],
                'country': request.POST['country'],
                'postcode': request.POST['postcode'],
                'town_or_city': request.POST['town_or_city'],
                'street_address1': request.POST['street_address1'],
                'street_address2': request.POST['street_address2'],
                'county': request.POST['county'],
            }

            order_form = OrderForm(form_data)
            if order_form.is_valid():
                order = order_form.save(commit=False)
                pid = request.POST.get('client_secret').split('_secret')[0]
                order.stripe_pid = pid
                order.original_bag = json.dumps(bag)
                order.save()
                for item_id, item_data in bag.items():
                    try:
                        book = Book.objects.get(id=item_id)
                        if isinstance(item_data, int):
                            if book.amount < item_data:
                                raise BookUnavailableBook
                            order_line_item = OrderLineItem(
                                order=order,
                                book=book,
                                quantity=item_data,
                            )
                            order_line_item.save()
                            book.amount = book.amount - item_data
                            book.save()
                        else:
                            for size, quantity in item_data['items_by_size'].items():
                                if book.amount < quantity:
                                    raise BookUnavailableBook
                                order_line_item = OrderLineItem(
                                    order=order,
                                    book=book,
                                    quantity=quantity,
                                    book_size=size,
                                )
                                order_line_item.save()
                                book.amount = book.amount - quantity
                                book.save()
                    except Book.DoesNotExist:
                        messages.error(request, (
                            "One of the books in your bag wasn't "
                            "found in our database. "
                            "Please call us for assistance!")
                        )
                        order.delete()
                        return redirect(reverse('view_bag'))
                    except BookUnavailableBook:
                        messages.error(request, "the {} book does not have the requested demand for purchase. Available quantity {}.".format(book.name, book.amount))
                        order.delete()
                        return redirect(reverse('view_bag'))

                # Save the info to the user's profile if all is well
                request.session['save_info'] = 'save-info' in request.POST
                return redirect(reverse('checkout_success',
                                        args=[order.order_number]))
            else:
                messages.error(request, ('There was an error with your form. ''Please double check your information.'))
        else:
            bag = request.session.get('bag', {})
            if not bag:
                messages.error(request, "There's nothing in your bag at the moment")
                return redirect(reverse('books'))

            current_bag = bag_contents(request)
            total = current_bag['grand_total']
            stripe_total = round(total * 100)
            stripe.api_key = stripe_secret_key
            intent = stripe.PaymentIntent.create(
                amount=stripe_total,
                currency=settings.STRIPE_CURRENCY,
            )

            # Attempt to prefill the form with any info
            # the user maintains in their profile
            if request.user.is_authenticated:
                try:
                    profile = UserProfile.objects.get(user=request.user)
                    order_form = OrderForm(initial={
                        'full_name': profile.user.get_full_name(),
                        'email': profile.user.email,
                        'phone_number': profile.default_phone_number,
                        'country': profile.default_country,
                        'postcode': profile.default_postcode,
                        'town_or_city': profile.default_town_or_city,
                        'street_address1': profile.default_street_address1,
                        'street_address2': profile.default_street_address2,
                        'county': profile.default_county,
                    })
                except UserProfile.DoesNotExist:
                    order_form = OrderForm()
            else:
                order_form = OrderForm()

        if not stripe_public_key:
            messages.warning(request, ('Stripe public key is missing. ' 'Did you forget to set it in ' 'your environment?'))

        template = 'checkout/checkout.html'
        context = {
            'order_form': order_form,
            'stripe_public_key': stripe_public_key,
            'client_secret': intent.client_secret,
        }

        return render(request, template, context)
    else:
        return redirect(reverse('account_login'))


def checkout_success(request, order_number):
    """
    Handle successful checkouts
    """
    save_info = request.session.get('save_info')
    order = get_object_or_404(Order, order_number=order_number)

    if request.user.is_authenticated:
        profile = UserProfile.objects.get(user=request.user)
        # Attach the user's profile to the order
        order.user_profile = profile
        order.save()

        # Save the user's info
        if save_info:
            profile_data = {
                'default_phone_number': order.phone_number,
                'default_country': order.country,
                'default_postcode': order.postcode,
                'default_town_or_city': order.town_or_city,
                'default_street_address1': order.street_address1,
                'default_street_address2': order.street_address2,
                'default_county': order.county,
            }
            user_profile_form = UserProfileForm(profile_data, instance=profile)
            if user_profile_form.is_valid():
                user_profile_form.save()

    messages.success(request, f'Order successfully processed! \
        Your order number is {order_number}. A confirmation \
        email will be sent to {order.email}.')

    if 'bag' in request.session:
        del request.session['bag']

    template = 'checkout/checkout_success.html'
    context = {
        'order': order,
    }

    return render(request, template, context)


```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/webhook_handler.py `  |

No errors identified
```
from django.http import HttpResponse
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.conf import settings

from .models import Order, OrderLineItem
from books.models import Book
from profiles.models import UserProfile

import json
import time


class StripeWH_Handler:
    """Handle Stripe webhooks"""

    def __init__(self, request):
        self.request = request

    def _send_confirmation_email(self, order):
        """Send the user a confirmation email"""
        cust_email = order.email
        subject = render_to_string(
            'checkout/confirmation_emails/confirmation_email_subject.txt',
            {'order': order})
        body = render_to_string(
            'checkout/confirmation_emails/confirmation_email_body.txt',
            {'order': order, 'contact_email': settings.DEFAULT_FROM_EMAIL})

        send_mail(
            subject,
            body,
            settings.DEFAULT_FROM_EMAIL,
            [cust_email]
        )

    def handle_event(self, event):
        """
        Handle a generic/unknown/unexpected webhook event
        """
        return HttpResponse(
            content=f'Unhandled webhook received: {event["type"]}',
            status=200)

    def handle_payment_intent_succeeded(self, event):
        """
        Handle the payment_intent.succeeded webhook from Stripe
        """
        intent = event.data.object
        pid = intent.id
        bag = intent.metadata.bag
        save_info = intent.metadata.save_info

        billing_details = intent.charges.data[0].billing_details
        shipping_details = intent.shipping
        grand_total = round(intent.charges.data[0].amount / 100, 2)

        # Clean data in the shipping details
        for field, value in shipping_details.address.items():
            if value == "":
                shipping_details.address[field] = None

        # Update profile information if save_info was checked
        profile = None
        username = intent.metadata.username
        if username != 'AnonymousUser':
            profile = UserProfile.objects.get(user__username=username)
            if save_info:
                profile.default_phone_number = shipping_details.phone
                profile.default_country = shipping_details.address.country
                profile.default_postcode = shipping_details.address.postal_code
                profile.default_town_or_city = shipping_details.address.city
                profile.default_street_address1 = shipping_details.address.line1
                profile.default_street_address2 = shipping_details.address.line2
                profile.default_county = shipping_details.address.state
                profile.save()

        order_exists = False
        attempt = 1
        while attempt <= 5:
            try:
                order = Order.objects.get(
                    full_name__iexact=shipping_details.name,
                    email__iexact=billing_details.email,
                    phone_number__iexact=shipping_details.phone,
                    country__iexact=shipping_details.address.country,
                    postcode__iexact=shipping_details.address.postal_code,
                    town_or_city__iexact=shipping_details.address.city,
                    street_address1__iexact=shipping_details.address.line1,
                    street_address2__iexact=shipping_details.address.line2,
                    county__iexact=shipping_details.address.state,
                    grand_total=grand_total,
                    original_bag=bag,
                    stripe_pid=pid,
                )
                order_exists = True
                break
            except Order.DoesNotExist:
                attempt += 1
                time.sleep(1)
        if order_exists:
            self._send_confirmation_email(order)
            return HttpResponse(
                content=(f'Webhook received: {event["type"]} | SUCCESS: '
                         'Verified order already in database'),
                status=200)
        else:
            order = None
            try:
                order = Order.objects.create(
                    full_name=shipping_details.name,
                    user_profile=profile,
                    email=billing_details.email,
                    phone_number=shipping_details.phone,
                    country=shipping_details.address.country,
                    postcode=shipping_details.address.postal_code,
                    town_or_city=shipping_details.address.city,
                    street_address1=shipping_details.address.line1,
                    street_address2=shipping_details.address.line2,
                    county=shipping_details.address.state,
                    original_bag=bag,
                    stripe_pid=pid,
                )
                for item_id, item_data in json.loads(bag).items():
                    book = Book.objects.get(id=item_id)
                    if isinstance(item_data, int):
                        order_line_item = OrderLineItem(
                            order=order,
                            book=book,
                            quantity=item_data,
                        )
                        order_line_item.save()
                    else:
                        for size, quantity in item_data['items_by_size'].items():
                            order_line_item = OrderLineItem(
                                order=order,
                                book=book,
                                quantity=quantity,
                                book_size=size,
                            )
                            order_line_item.save()
            except Exception as e:
                if order:
                    order.delete()
                return HttpResponse(
                    content=f'Webhook received: {event["type"]} | ERROR: {e}',
                    status=500)
        self._send_confirmation_email(order)
        return HttpResponse(
            content=(f'Webhook received: {event["type"]} | SUCCESS: '
                     'Created order in webhook'),
            status=200)

    def handle_payment_intent_payment_failed(self, event):
        """
        Handle the payment_intent.payment_failed webhook from Stripe
        """
        return HttpResponse(
            content=f'Webhook received: {event["type"]}',
            status=200)

```

| File |   file path  |
| --- |   ---  |
| 01 |  `checkout/webhooks.py `  |

No errors identified
```
from django.conf import settings
from django.http import HttpResponse
from django.views.decorators.http import require_POST
from django.views.decorators.csrf import csrf_exempt

from checkout.webhook_handler import StripeWH_Handler

import stripe


@require_POST
@csrf_exempt
def webhook(request):
    """Listen for webhooks from Stripe"""
    # Setup
    wh_secret = settings.STRIPE_WH_SECRET
    stripe.api_key = settings.STRIPE_SECRET_KEY

    # Get the webhook data and verify its signature
    payload = request.body
    sig_header = request.META['HTTP_STRIPE_SIGNATURE']
    event = None

    try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, wh_secret
        )
    except ValueError as e:
        # Invalid payload
        return HttpResponse(content=e, status=400)
    except stripe.error.SignatureVerificationError as e:
        # Invalid signature
        return HttpResponse(content=e, status=400)
    except Exception as e:
        return HttpResponse(content=e, status=400)

    # Set up a webhook handler
    handler = StripeWH_Handler(request)

    # Map webhook events to relevant handler functions
    event_map = {
        'payment_intent.succeeded': handler.handle_payment_intent_succeeded,
        'payment_intent.payment_failed': handler.handle_payment_intent_payment_failed,
    }

    # Get the webhook type from Stripe
    event_type = event['type']

    # If there's a handler for it, get it from the event map
    # Use the generic one by default
    event_handler = event_map.get(event_type, handler.handle_event)

    # Call the event handler with the event
    response = event_handler(event)
    return response

```
